<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>SISTEMA DE TRANSMISIÓN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="stylesheet" href="transmitir-styles.css" />
</head>

<body>
  <header>
    <h1>SISTEMA DE TRANSMISIÓN</h1>
  </header>

  <div class="container">
    <div class="info-card">
      <div>Ingrese código</div>
      <input id="codigoInput" type="text"  />
    </div>

    <video id="localVideo" autoplay playsinline muted></video>

    <div class="status">
      Estado: <span id="estadoText">Listo para transmitir</span>
    </div>

    <button class="btn btn-primary" id="btnToggle">Iniciar transmisión</button>
  </div>

  <!-- SOCKET.IO -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

  <script>
    const SIGNALING_URL = "https://bodycam-server-200816039529.us-central1.run.app";

    const pcConfig = {
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    };

    let socket, pc, localStream, roomId;
    let transmitting = false;

    const videoEl = document.getElementById("localVideo");
    const estadoText = document.getElementById("estadoText");
    const btnToggle = document.getElementById("btnToggle");

    function setEstado(msg) {
      estadoText.textContent = msg;
      console.log(msg);
    }

    async function startTransmission() {
      roomId = document.getElementById("codigoInput").value.trim().toUpperCase();
      if (!roomId) return alert("Ingresa un código para la transmisión");

      try {
        setEstado("Permisos de cámara...");

        // ⭐ UNIVERSAL (iOS + Android) — pedir SOLO cámara primero
        localStream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { ideal: "environment" }
          },
          audio: false
        });

        videoEl.srcObject = localStream;

        socket = io(SIGNALING_URL, { transports: ["websocket"] });

        socket.on("connect", () => {
          setEstado("Conectado al servidor.");
          socket.emit("join-room", { roomId, role: "sender" });
        });

        pc = new RTCPeerConnection(pcConfig);

        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

        pc.onicecandidate = (e) => {
          if (e.candidate) {
            socket.emit("ice-candidate", { roomId, candidate: e.candidate });
          }
        };

        socket.on("answer", async ({ answer }) => {
          await pc.setRemoteDescription(new RTCSessionDescription(answer));
        });

        socket.on("ice-candidate", async ({ candidate }) => {
          candidate && pc.addIceCandidate(new RTCIceCandidate(candidate));
        });

        setEstado("Creando oferta...");

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        socket.emit("offer", { roomId, offer });

        // ⭐ Después de conectar, pedir audio (iOS lo permite después)
        setTimeout(async () => {
          try {
            const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioStream.getTracks().forEach(t => pc.addTrack(t, audioStream));
          } catch (e) {
            console.warn("Audio no permitido aún, pero video sí funciona.");
          }
        }, 1500);

        transmitting = true;
        btnToggle.textContent = "Detener transmisión";
        btnToggle.classList.remove("btn-primary");
        btnToggle.classList.add("btn-danger");

        setEstado("Esperando visor...");
      } catch (err) {
        console.error(err);
        setEstado("Error iniciando cámara.");
      }
    }

    function stopTransmission() {
      socket && socket.disconnect();
      pc && pc.close();
      localStream && localStream.getTracks().forEach(t => t.stop());

      videoEl.srcObject = null;

      transmitting = false;
      btnToggle.textContent = "Iniciar transmisión";
      btnToggle.classList.add("btn-primary");
      btnToggle.classList.remove("btn-danger");

      setEstado("Transmisión detenida.");
    }

    btnToggle.onclick = () =>
      transmitting ? stopTransmission() : startTransmission();
  </script>
</body>
</html>
