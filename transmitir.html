<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>SISTEMA DE TRANSMISI√ìN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="transmitir-styles.css" />
</head>

<body>

  <header>
    <h1>SISTEMA DE TRANSMISI√ìN</h1>
  </header>

  <div class="container">

    <!-- DATOS DEL SERENO -->
    <div class="info-card">
      <label for="codigoInput">C√≥digo de transmisi√≥n</label>
      <input id="codigoInput" type="text" placeholder="Ej: S01" />

      <label for="nombreInput">Nombre completo</label>
      <input id="nombreInput" type="text" placeholder="Nombres y apellidos" />

      <label for="dniInput">DNI</label>
      <input id="dniInput" type="text" placeholder="Ej: 12345678" />
    </div>

    <!-- VIDEO LOCAL -->
    <div class="video-area">
      <video id="localVideo" autoplay playsinline muted></video>
    </div>

    <!-- ESTADO -->
    <div class="status">
      Estado: <span id="estadoText">Listo para transmitir</span><br />
      <small id="gpsText">GPS: sin ubicaci√≥n</small>
    </div>

    <!-- BOT√ìN PRINCIPAL -->
    <button class="btn btn-primary" id="btnToggle">Iniciar transmisi√≥n</button>

  </div>

  <!-- SOCKET.IO -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

  <!-- SCRIPT PRINCIPAL -->
  <script type="module">
    import {
      db,
      collection,
      addDoc,
      updateDoc,
      serverTimestamp
    } from "./firebase-config.js";

    /*
    ========================================================
    CONFIG
    ========================================================
    */
    const SIGNALING_URL = "https://bodycam-server-200816039529.us-central1.run.app";

    const pcConfig = {
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    };

    let socket = null;
    let pc = null;
    let localStream = null;
    let roomId = null;
    let transmitting = false;

    let currentDocRef = null; // Firestore doc del registro

    /*
    ========================================================
    DOM
    ========================================================
    */
    const videoEl   = document.getElementById("localVideo");
    const estadoEl  = document.getElementById("estadoText");
    const gpsEl     = document.getElementById("gpsText");
    const btnToggle = document.getElementById("btnToggle");

    const codigoInput = document.getElementById("codigoInput");
    const nombreInput = document.getElementById("nombreInput");
    const dniInput    = document.getElementById("dniInput");


    function setEstado(msg) {
      estadoEl.textContent = msg;
      console.log("[ESTADO]", msg);
    }

    function setGPS(msg) {
      gpsEl.textContent = "GPS: " + msg;
      console.log("[GPS]", msg);
    }

    /*
    ========================================================
    üîµ FIRESTORE
    ========================================================
    */

    function getFechaYHora() {
      const now = new Date();
      const d = String(now.getDate()).padStart(2, "0");
      const m = String(now.getMonth() + 1).padStart(2, "0");
      const y = now.getFullYear();
      const h = String(now.getHours()).padStart(2, "0");
      const min = String(now.getMinutes()).padStart(2, "0");

      return {
        fechaKey: `${d}-${m}-${y}`,
        fechaTexto: `${d}-${m}-${y}`,
        horaTexto: `${h}:${min}`
      };
    }

    async function registrarInicio({ codigo, nombre, dni }) {
      const { fechaKey, fechaTexto, horaTexto } = getFechaYHora();

      let lat = null, lng = null;

      setGPS("obteniendo ubicaci√≥n‚Ä¶");

      try {
        const pos = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 8000
          });
        });

        lat = pos.coords.latitude;
        lng = pos.coords.longitude;
        setGPS(`${lat.toFixed(5)}, ${lng.toFixed(5)}`);

      } catch (err) {
        setGPS("no disponible");
      }

      const colRef = collection(db, "videos", fechaKey, "registros");

      const payload = {
        codigo,
        nombre,
        dni,
        fecha: fechaTexto,
        hora: horaTexto,
        lat,
        lng,
        activo: true,
        creadoEn: serverTimestamp()
      };

      const docRef = await addDoc(colRef, payload);
      console.log("üî• Doc creado:", docRef.id);
      return docRef;
    }

    async function marcarFin() {
      if (!currentDocRef) return;
      await updateDoc(currentDocRef, {
        activo: false,
        finalizadoEn: serverTimestamp()
      });
      console.log("üìå Marcado como finalizado");
    }

    /*
    ========================================================
    üîµ WEBRTC + SOCKET.IO
    ========================================================
    */

    function prepararSocket() {
      if (socket) {
        socket.disconnect();
        socket = null;
      }

      socket = io(SIGNALING_URL, { transports: ["websocket"] });

      socket.on("connect", () => {
        console.log("üîó Socket conectado");
        socket.emit("join-room", { roomId, role: "sender" });
      });

      socket.on("answer", async ({ answer }) => {
        console.log("‚¨ÖÔ∏è ANSWER recibida");
        if (pc.signalingState !== "closed") {
          await pc.setRemoteDescription(new RTCSessionDescription(answer));
        }
      });

      socket.on("ice-candidate", ({ candidate }) => {
        if (candidate && pc) {
          pc.addIceCandidate(new RTCIceCandidate(candidate));
        }
      });

      socket.on("user-joined", () => {
        console.log("üëÅ Visor se conect√≥ ‚Üí reenviando offer");
        reenviarOferta();
      });
    }

    async function crearPeerConnection() {
      pc = new RTCPeerConnection(pcConfig);

      pc.onicecandidate = (e) => {
        if (e.candidate) {
          socket.emit("ice-candidate", {
            roomId,
            candidate: e.candidate
          });
        }
      };

      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
    }

    async function reenviarOferta() {
      if (!pc) return;

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      socket.emit("offer", { roomId, offer });
      console.log("‚û°Ô∏è OFFER reenviada");
      setEstado("Conectando visor‚Ä¶");
    }

    /*
    ========================================================
    üîµ CONTROLES PRINCIPALES
    ========================================================
    */

    async function start() {
      roomId = codigoInput.value.trim().toUpperCase();
      const nombre = nombreInput.value.trim();
      const dni    = dniInput.value.trim();

      if (!roomId) return alert("Ingresa el c√≥digo");
      if (!nombre) return alert("Ingresa el nombre");
      if (!dni)    return alert("Ingresa el DNI");

      try {
        setEstado("Activando c√°mara...");

        localStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" },
          audio: false
        });

        videoEl.srcObject = localStream;

        prepararSocket();
        await crearPeerConnection();
        await reenviarOferta();

        setEstado("Registrando en Firestore‚Ä¶");

        currentDocRef = await registrarInicio({ codigo: roomId, nombre, dni });

        transmitting = true;
        btnToggle.textContent = "Detener transmisi√≥n";
        btnToggle.classList.remove("btn-primary");
        btnToggle.classList.add("btn-danger");

        setEstado("Esperando visor‚Ä¶");

      } catch (err) {
        console.error("ERROR:", err);
        alert("Error iniciando transmisi√≥n");
      }
    }

    async function stop() {
      if (socket) socket.disconnect();
      if (pc) pc.close();

      if (localStream) {
        localStream.getTracks().forEach(t => t.stop());
      }

      videoEl.srcObject = null;

      await marcarFin();
      currentDocRef = null;

      transmitting = false;
      btnToggle.textContent = "Iniciar transmisi√≥n";
      btnToggle.classList.add("btn-primary");
      btnToggle.classList.remove("btn-danger");

      setEstado("Transmisi√≥n detenida");
    }

    btnToggle.onclick = () => transmitting ? stop() : start();

  </script>

</body>
</html>
