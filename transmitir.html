<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>SISTEMA DE TRANSMISIN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="transmitir-styles.css" />
</head>

<body>

  <header>
    <h1>SISTEMA DE TRANSMISIN</h1>
  </header>

  <div class="container">

    <!-- INPUT DEL CDIGO -->
    <div class="info-card">
      <label>Ingrese c贸digo</label>
      <input id="codigoInput" type="text" placeholder="Ej: S01" />
    </div>

    <!--  AREA DEL VIDEO (ahora s铆 existe) -->
    <div class="video-area">
      <video id="localVideo" autoplay playsinline muted></video>
    </div>

    <!-- ESTADO -->
    <div class="status">
      Estado: <span id="estadoText">Listo para transmitir</span>
    </div>

    <!-- BOTN -->
    <button class="btn btn-primary" id="btnToggle">Iniciar transmisi贸n</button>

  </div>

  <!-- SOCKET.IO -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

  <!-- SCRIPT PRINCIPAL -->
  <script>
    const SIGNALING_URL = "https://bodycam-server-200816039529.us-central1.run.app";

    const pcConfig = {
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    };

    let socket, pc, localStream, roomId;
    let transmitting = false;

    const videoEl = document.getElementById("localVideo");
    const estadoText = document.getElementById("estadoText");
    const btnToggle = document.getElementById("btnToggle");

    function setEstado(msg) {
      estadoText.textContent = msg;
    }

    async function startTransmission() {
      roomId = document.getElementById("codigoInput").value.trim().toUpperCase();
      if (!roomId) return alert("Ingresa un c贸digo");

      try {
        setEstado("Activando c谩mara...");

        localStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" },
          audio: false
        });

        videoEl.srcObject = localStream;

        socket = io(SIGNALING_URL, { transports: ["websocket"] });

        socket.on("connect", () => {
          setEstado("Conectado al servidor");
          socket.emit("join-room", { roomId, role: "sender" });
        });

        pc = new RTCPeerConnection(pcConfig);
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

        pc.onicecandidate = (e) => {
          if (e.candidate) {
            socket.emit("ice-candidate", { roomId, candidate: e.candidate });
          }
        };

        socket.on("answer", async ({ answer }) => {
          await pc.setRemoteDescription(new RTCSessionDescription(answer));
        });

        socket.on("ice-candidate", async ({ candidate }) => {
          candidate && pc.addIceCandidate(new RTCIceCandidate(candidate));
        });

        setEstado("Creando oferta...");
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        socket.emit("offer", { roomId, offer });

        transmitting = true;
        btnToggle.textContent = "Detener transmisi贸n";
        btnToggle.classList.remove("btn-primary");
        btnToggle.classList.add("btn-danger");

        setEstado("Esperando visor...");

      } catch (err) {
        console.error(err);
        setEstado("Error al activar c谩mara");
      }
    }

    function stopTransmission() {
      socket && socket.disconnect();
      pc && pc.close();
      localStream && localStream.getTracks().forEach(t => t.stop());

      videoEl.srcObject = null;

      transmitting = false;
      btnToggle.textContent = "Iniciar transmisi贸n";
      btnToggle.classList.add("btn-primary");
      btnToggle.classList.remove("btn-danger");

      setEstado("Transmisi贸n detenida");
    }

    btnToggle.onclick = () => transmitting ? stopTransmission() : startTransmission();
  </script>

</body>
</html>
