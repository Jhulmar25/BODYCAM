<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>BodyCam – Sereno</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #0b0d13;
      font-family: "Segoe UI", sans-serif;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
    }

    header {
      width: 100%;
      background: #11141c;
      padding: 14px 20px;
      text-align: center;
      border-bottom: 2px solid #1f232d;
    }

    header h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: 0.5px;
    }

    .container {
      margin-top: 16px;
      width: 100%;
      max-width: 480px;
      padding: 0 16px 20px;
      box-sizing: border-box;
    }

    .info-card {
      background: #151926;
      padding: 12px 14px;
      border-radius: 12px;
      margin-bottom: 14px;
      font-size: 14px;
      color: #d2d7e5;
    }

    .label {
      font-size: 13px;
      color: #8e96aa;
      margin-bottom: 4px;
    }

    video {
      width: 100%;
      border-radius: 12px;
      background: black;
      margin-top: 10px;
      max-height: 320px;
    }

    .status {
      margin-top: 8px;
      font-size: 13px;
      color: #9fa7c0;
    }

    .status span {
      font-weight: 600;
    }

    .btn {
      margin-top: 16px;
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 999px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s;
    }

    .btn-primary {
      background: #2b82ff;
      color: white;
    }

    .btn-danger {
      background: #ff3b3b;
      color: white;
    }
  </style>
</head>

<body>
  <header>
    <h1>BodyCam – Sereno</h1>
  </header>

  <div class="container">
    <div class="info-card">
      <div class="label">Código de Sereno</div>
      <input id="codigoInput" type="text" placeholder="Ej: S01" />
    </div>

    <video id="localVideo" autoplay playsinline muted></video>

    <div class="status" id="statusText">
      Estado: <span>Listo para transmitir</span>
    </div>

    <button class="btn btn-primary" id="btnToggle">
      Iniciar transmisión
    </button>
  </div>

  <!-- Socket.IO CORRECTO -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

  <script>
    const SIGNALING_URL = "https://bodycam-server-200816039529.us-central1.run.app";

    const pcConfig = {
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" },
        { urls: "stun:stun1.l.google.com:19302" }
      ]
    };

    let socket, pc, localStream, roomId, transmitting = false;

    const videoEl = document.getElementById("localVideo");
    const btnToggle = document.getElementById("btnToggle");
    const statusText = document.getElementById("statusText").querySelector("span");
    const codigoInput = document.getElementById("codigoInput");

    function setStatus(msg) {
      statusText.textContent = msg;
      console.log(msg);
    }

    async function startTransmission() {
      roomId = codigoInput.value.trim().toUpperCase();
      if (!roomId) return alert("Escribe un código (Ej: S01)");

      try {
        setStatus("Solicitando cámara...");

        localStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" },
          audio: true,
        });

        videoEl.srcObject = localStream;

        socket = io(SIGNALING_URL, { transports: ["websocket"] });

        socket.on("connect", () => {
          setStatus("Conectado al servidor.");
          socket.emit("join-room", { roomId, role: "sender" });
        });

        socket.on("answer", async ({ answer }) => {
          await pc.setRemoteDescription(new RTCSessionDescription(answer));
        });

        socket.on("ice-candidate", async ({ candidate }) => {
          candidate && pc.addIceCandidate(new RTCIceCandidate(candidate));
        });

        pc = new RTCPeerConnection(pcConfig);
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

        pc.onicecandidate = (e) => {
          if (e.candidate) {
            socket.emit("ice-candidate", { roomId, candidate: e.candidate });
          }
        };

        pc.onconnectionstatechange = () => {
          if (pc.connectionState === "connected") {
            setStatus("Transmitiendo en vivo.");
          }
        };

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        socket.emit("offer", { roomId, offer });

        transmitting = true;
        btnToggle.textContent = "Detener transmisión";
        btnToggle.classList.remove("btn-primary");
        btnToggle.classList.add("btn-danger");
      } catch (err) {
        console.error(err);
        setStatus("Error al iniciar.");
      }
    }

    function stopTransmission() {
      socket && socket.disconnect();
      pc && pc.close();
      localStream && localStream.getTracks().forEach(t => t.stop());
      videoEl.srcObject = null;
      transmitting = false;

      btnToggle.textContent = "Iniciar transmisión";
      btnToggle.classList.remove("btn-danger");
      btnToggle.classList.add("btn-primary");

      setStatus("Transmisión detenida.");
    }

    btnToggle.onclick = () => transmitting ? stopTransmission() : startTransmission();
  </script>
</body>
</html>
