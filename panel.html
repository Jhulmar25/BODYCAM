<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>BodyCam – Panel Supervisor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #050711;
      font-family: "Segoe UI", sans-serif;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .container {
      width: 100%;
      max-width: 720px;
      padding: 20px;
    }

    input, button {
      padding: 10px;
      margin: 5px 0;
      border-radius: 8px;
    }

    button {
      cursor: pointer;
      font-weight: bold;
      font-size: 15px;
    }

    #remoteVideo {
      width: 100%;
      background: black;
      margin-top: 20px;
      border-radius: 12px;
    }
  </style>
</head>

<body>
  <h1>BodyCam – Panel de Supervisión</h1>

  <div class="container">
    <input id="codigoSereno" type="text" placeholder="Código (S01)" />
    <button id="btnConectar">Ver transmisión</button>
    <button id="btnDesconectar">Detener</button>

    <video id="remoteVideo" autoplay playsinline></video>

    <p id="estadoTexto">Estado: Esperando conexión...</p>
  </div>

  <!-- Socket.IO CORRECTO -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

  <script>
    const SIGNALING_URL = "https://bodycam-server-200816039529.us-central1.run.app";

    const pcConfig = {
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" }
      ]
    };

    let socket = null;
    let pc = null;
    let roomId = null;

    function setEstado(msg) {
      document.getElementById("estadoTexto").textContent = "Estado: " + msg;
      console.log(msg);
    }

    async function connectViewer() {
      roomId = document.getElementById("codigoSereno").value.trim().toUpperCase();
      if (!roomId) return alert("Ingresa el código del sereno.");

      socket = io(SIGNALING_URL, { transports: ["websocket"] });

      socket.on("connect", () => {
        setEstado("Conectado. Esperando transmisión...");
        socket.emit("join-room", { roomId, role: "viewer" });
      });

      socket.on("offer", async ({ offer }) => {
        setEstado("Oferta recibida.");

        pc = new RTCPeerConnection(pcConfig);

        pc.ontrack = (event) => {
          document.getElementById("remoteVideo").srcObject = event.streams[0];
          setEstado("En vivo.");
        };

        pc.onicecandidate = (e) => {
          if (e.candidate) {
            socket.emit("ice-candidate", { roomId, candidate: e.candidate });
          }
        };

        await pc.setRemoteDescription(new RTCSessionDescription(offer));

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        socket.emit("answer", { roomId, answer });
      });

      socket.on("ice-candidate", async ({ candidate }) => {
        candidate && pc.addIceCandidate(new RTCIceCandidate(candidate));
      });
    }

    function disconnectViewer() {
      socket && socket.disconnect();
      pc && pc.close();
      setEstado("Conexión cerrada.");
    }

    document.getElementById("btnConectar").onclick = connectViewer;
    document.getElementById("btnDesconectar").onclick = disconnectViewer;
  </script>
</body>
</html>
